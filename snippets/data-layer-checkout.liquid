<script>
const event_prefix = 'SME_';
const formattedItemId = true;
const GTM_container_url = 'https://www.googletagmanager.com';
const GTM_container_id = 'GTM-NJ8WB5'; // Replace with your GTM ID
// Retrieve the store country code from localStorage or default to 'IT'
storeCountryCode = storeCountryCode || 'IT';
window.dataLayer = window.dataLayer || [];

// Function to push arguments to the dataLayer
function gtag() {
    dataLayer.push(arguments);
}

if (window.location.href.includes('/checkouts/cn/')) {
    
    // DataLayer Events
    analytics.subscribe('payment_info_submitted', (event) => ecommerceDataLayer('add_payment_info', event));

    analytics.subscribe('checkout_shipping_info_submitted', (event) => ecommerceDataLayer('add_shipping_info', event));

    analytics.subscribe('checkout_completed', (event) => ecommerceDataLayer('purchase', event));

}


async function sha256Hash(value) {
    const encoder = new TextEncoder();
    const data = encoder.encode(value);

    const hashBuffer = await crypto.subtle.digest('SHA-256', data);

    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashedValue = hashArray.map(byte => ('00' + byte.toString(16)).slice(-2)).join('');
    return hashedValue;
}

async function ecommerceDataLayer(gtm_event_name, event) {  
    let hash_email;
    let hash_phone;
    const phone = event.data?.checkout?.phone;
    const email = event.data?.checkout?.email;

    if (phone) {
        hash_phone = await sha256Hash(phone);
    }

    if (email) {
        hash_email = await sha256Hash(email);
    }


    const customerInfo = {
        customer: {
            first_name: event.data?.checkout?.billingAddress?.firstName,
            last_name: event.data?.checkout?.billingAddress?.lastName,
            email: email,
            hash_email: hash_email,
            phone: phone,
            hash_phone: hash_phone,
            address: event.data?.checkout?.billingAddress
        }
    }
    dataLayer.push(customerInfo);

    const dataLayerInfo = {
        event: event_prefix + gtm_event_name,
        ecommerce: {
            transaction_id: event.data?.checkout?.order?.id,
            value: event.data?.checkout?.totalPrice?.amount,
            tax: event.data?.checkout?.totalTax?.amount,
            shipping: event.data?.checkout?.shippingLine?.price?.amount,
            currency: event.data?.checkout?.currencyCode,
            coupon: (event.data?.checkout?.discountApplications || []).map(discount => discount.title).join(','),
            items: (event.data?.checkout?.lineItems || []).map(item => ({
                item_id: formattedItemId ? 'shopify_' + storeCountryCode + '_' + (item.variant?.product?.id || '') + '_' + (item.variant?.id || '') : item.variant?.product?.id,
                product_id: item.variant?.product?.id,
                variant_id: item.variant?.id,
                item_name: item.title,
                coupon: item.discountAllocations?.discountApplication?.title,
                discount: item.discountAllocations?.amount?.amount,
                item_variant: item.variant?.title,
                price: item.variant?.price?.amount,
                quantity: item.quantity,
                item_brand: item.variant?.product?.vendor,
                item_category: item.variant?.product?.type

            }))
        }
    }

    dataLayer.push({
        ecommerce: null
    });
    dataLayer.push(dataLayerInfo);

    console.log('Event: ' + event_prefix + gtm_event_name, Object.assign(dataLayerInfo, customerInfo));
}
</script>